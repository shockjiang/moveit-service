<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoveIt Grasp Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f9b8e 0%, #1a1a2e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f9b8e 0%, #1a1a2e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 2.2em;
            margin-bottom: 6px;
        }

        .header-left p {
            font-size: 1.05em;
            opacity: 0.85;
        }

        .status-badge {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-badge.healthy { background: #2ecc71; color: #fff; }
        .status-badge.error   { background: #e74c3c; color: #fff; }
        .status-badge.loading { background: rgba(255,255,255,0.25); color: #fff; }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0f9b8e;
        }

        /* Upload panels */
        .upload-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #0f9b8e;
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0faf9;
            position: relative;
        }

        .upload-area:hover {
            border-color: #1a1a2e;
            background: #e0f5f3;
        }

        .upload-area.has-file {
            border-style: solid;
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .upload-icon {
            font-size: 2.5em;
            color: #0f9b8e;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 1.1em;
            color: #555;
        }

        .upload-text small {
            color: #999;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-filename {
            margin-top: 8px;
            font-size: 0.9em;
            color: #0f9b8e;
            font-weight: 600;
        }

        /* Preview */
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .preview-item {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-item .preview-label {
            padding: 10px;
            font-size: 0.9em;
            color: #555;
            text-align: center;
            background: #f9f9f9;
            font-weight: 600;
        }

        /* Form inputs */
        .input-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 16px;
            align-items: end;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #0f9b8e;
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            color: #777;
            font-size: 0.9em;
        }

        /* Buttons */
        .btn {
            padding: 14px 36px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f9b8e 0%, #1a1a2e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(15, 155, 142, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0f9b8e;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #555;
            font-size: 1.05em;
        }

        /* Error */
        .error-message {
            display: none;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .error-message.show {
            display: block;
        }

        /* Results */
        .results-container {
            display: none;
        }

        .results-container.show {
            display: block;
        }

        /* Visualization card */
        .vis-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .vis-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Detection summary */
        .summary-bar {
            background: #f0faf9;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-item {
            font-size: 0.95em;
        }

        .summary-item strong {
            color: #0f9b8e;
        }

        /* Results table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            margin-bottom: 25px;
        }

        .results-table th {
            background: #1a1a2e;
            color: white;
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
        }

        .results-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .results-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .results-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover td {
            background: #f9f9f9;
        }

        .status-ok {
            color: #2ecc71;
            font-weight: 600;
        }

        .status-fail {
            color: #e74c3c;
            font-weight: 600;
        }

        .result-row-ok {
            border-left: 4px solid #2ecc71;
        }

        .result-row-fail {
            border-left: 4px solid #e74c3c;
        }

        /* Object detail cards */
        .object-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .object-card {
            background: #f9f9f9;
            border-left: 4px solid #0f9b8e;
            border-radius: 4px;
            padding: 14px;
        }

        .object-card-header {
            font-weight: 700;
            color: #0f9b8e;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .object-card-row {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 3px;
        }

        .object-card-row strong {
            color: #333;
        }

        /* Collapsible JSON */
        .json-section {
            margin-top: 20px;
            background: #f8f9ff;
            border: 2px solid #0f9b8e;
            border-radius: 10px;
            overflow: hidden;
        }

        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
        }

        .json-header:hover {
            background: #f0faf9;
        }

        .json-title {
            font-size: 1.1em;
            color: #0f9b8e;
            font-weight: 600;
        }

        .btn-copy {
            padding: 6px 14px;
            background: #0f9b8e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }

        .btn-copy:hover {
            background: #0d8a7f;
        }

        .json-body {
            display: none;
            background: #2d2d2d;
            padding: 15px;
            max-height: 400px;
            overflow: auto;
        }

        .json-body pre {
            margin: 0;
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
            color: #f8f8f2;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .header-left h1 {
                font-size: 1.6em;
            }

            .upload-panels,
            .preview-container {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .object-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>MoveIt Grasp Planner</h1>
                <p>RGB-D Grasp Detection + MoveIt Trajectory Planning</p>
            </div>
            <span id="statusBadge" class="status-badge loading">checking...</span>
        </div>

        <div class="content">
            <!-- 1. Upload -->
            <div class="section">
                <h2 class="section-title">1. Upload Images</h2>
                <div class="upload-panels">
                    <div class="upload-area" id="rgbUploadArea" onclick="document.getElementById('rgbInput').click()">
                        <div class="upload-icon">&#x1f5bc;</div>
                        <div class="upload-text">
                            <strong>Click to upload RGB image</strong><br>
                            <small>JPG, PNG</small>
                        </div>
                        <input type="file" id="rgbInput" accept="image/*">
                        <div class="upload-filename" id="rgbFilename"></div>
                    </div>
                    <div class="upload-area" id="dptUploadArea" onclick="document.getElementById('dptInput').click()">
                        <div class="upload-icon">&#x1f4ca;</div>
                        <div class="upload-text">
                            <strong>Click to upload Depth image</strong><br>
                            <small>16-bit PNG (uint16)</small>
                        </div>
                        <input type="file" id="dptInput" accept="image/*">
                        <div class="upload-filename" id="dptFilename"></div>
                    </div>
                </div>
                <div class="preview-container" id="previewContainer"></div>
            </div>

            <!-- 2. Parameters -->
            <div class="section">
                <h2 class="section-title">2. Configure Parameters</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label for="textPrompt">Text Prompt</label>
                        <input type="text" id="textPrompt" value="object" placeholder="e.g. bottle.cup, object">
                        <small>Separate categories with "." (e.g. "bottle.cup"). Use "object" to detect all.</small>
                    </div>
                    <div class="input-group" style="max-width:160px">
                        <label for="numObjects">Objects to Plan</label>
                        <input type="number" id="numObjects" value="3" min="1" max="10">
                        <small>Top N by score</small>
                    </div>
                </div>
            </div>

            <!-- 3. Submit -->
            <div class="section">
                <button class="btn btn-primary" id="submitBtn" onclick="submitPlan()">
                    Plan Grasps
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Detecting objects and planning trajectories... This may take a while.</p>
            </div>

            <!-- Error -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Results -->
            <div class="section results-container" id="resultsContainer">
                <h2 class="section-title">Results</h2>

                <!-- Summary bar -->
                <div class="summary-bar" id="summaryBar"></div>

                <!-- Visualization image -->
                <div class="vis-card" id="visCard" style="display:none">
                    <img id="visImage" alt="Annotated visualization">
                </div>

                <!-- 3D Point Cloud & Trajectory -->
                <div id="viewer3dCard" class="vis-card" style="display:none">
                    <div style="padding:10px 15px; background:#f5f5f5; border-bottom:1px solid #ddd; font-weight:600;">
                        3D Point Cloud &amp; Trajectory
                    </div>
                    <div id="plot3d" style="width:100%; height:600px;"></div>
                </div>

                <!-- Per-object plan results table -->
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Object</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Trajectory Phases</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>

                <!-- Object detail cards -->
                <div class="object-details" id="objectDetails"></div>

                <!-- Raw JSON (collapsible) -->
                <div class="json-section" id="jsonSection" style="display:none">
                    <div class="json-header" onclick="toggleJson()">
                        <span class="json-title"><span id="jsonIcon">&#9654;</span> Raw JSON Response</span>
                        <button class="btn-copy" onclick="event.stopPropagation(); copyJson()">Copy JSON</button>
                    </div>
                    <div class="json-body" id="jsonBody">
                        <pre id="jsonPre"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="/static/plotly-2.35.2.min.js"></script>
<script>if(typeof Plotly==='undefined'){document.write('<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"><\/script>')}</script>
<script>
/* ------------------------------------------------------------------ */
/*  Init                                                               */
/* ------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', function() {
    checkHealth();
    initUpload('rgbInput', 'rgbUploadArea', 'rgbFilename', true);
    initUpload('dptInput', 'dptUploadArea', 'dptFilename', false);
});

function checkHealth() {
    var badge = document.getElementById('statusBadge');
    fetch('/health')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var stype = d.grasp_server_type || 'unknown';
            badge.textContent = d.status + ' | ' + d.robot + ' | ' + stype;
            badge.className = 'status-badge ' + (d.status === 'healthy' ? 'healthy' : 'error');
        })
        .catch(function() {
            badge.textContent = 'offline';
            badge.className = 'status-badge error';
        });
}

/* ------------------------------------------------------------------ */
/*  Upload handling                                                    */
/* ------------------------------------------------------------------ */
function initUpload(inputId, areaId, filenameId, showPreview) {
    var input = document.getElementById(inputId);
    var area = document.getElementById(areaId);

    input.addEventListener('change', function() {
        var file = this.files[0];
        var fnEl = document.getElementById(filenameId);
        if (file) {
            fnEl.textContent = file.name;
            area.classList.add('has-file');
            updatePreviews();
        } else {
            fnEl.textContent = '';
            area.classList.remove('has-file');
            updatePreviews();
        }
    });

    // Drag & drop
    area.addEventListener('dragover', function(e) { e.preventDefault(); area.style.borderColor = '#1a1a2e'; });
    area.addEventListener('dragleave', function(e) { e.preventDefault(); area.style.borderColor = ''; });
    area.addEventListener('drop', function(e) {
        e.preventDefault();
        area.style.borderColor = '';
        if (e.dataTransfer.files.length > 0) {
            input.files = e.dataTransfer.files;
            input.dispatchEvent(new Event('change'));
        }
    });
}

function updatePreviews() {
    var container = document.getElementById('previewContainer');
    container.innerHTML = '';
    var rgbFile = document.getElementById('rgbInput').files[0];
    var dptFile = document.getElementById('dptInput').files[0];
    if (!rgbFile && !dptFile) return;

    function addPreview(file, label) {
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = '<img src="' + e.target.result + '" alt="' + label + '">' +
                            '<div class="preview-label">' + label + ': ' + file.name + '</div>';
            container.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
    addPreview(rgbFile, 'RGB');
    addPreview(dptFile, 'Depth');
}

/* ------------------------------------------------------------------ */
/*  Submit                                                             */
/* ------------------------------------------------------------------ */
function submitPlan() {
    var rgbFile = document.getElementById('rgbInput').files[0];
    var dptFile = document.getElementById('dptInput').files[0];
    if (!rgbFile) { showError('Please upload an RGB image.'); return; }
    if (!dptFile) { showError('Please upload a Depth image.'); return; }

    var prompt = document.getElementById('textPrompt').value || 'object';
    var num = document.getElementById('numObjects').value || '3';

    var fd = new FormData();
    fd.append('rgb', rgbFile);
    fd.append('depth', dptFile);
    fd.append('text_prompt', prompt);
    fd.append('num_objects', num);

    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    hideError();
    document.getElementById('resultsContainer').classList.remove('show');
    document.getElementById('loading').classList.add('show');

    fetch('/grasp_plan', { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            document.getElementById('loading').classList.remove('show');
            if (data.success) {
                displayResults(data);
            } else {
                showError(data.message || 'Planning failed.');
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            document.getElementById('loading').classList.remove('show');
            showError('Request failed: ' + err.message);
        });
}

/* ------------------------------------------------------------------ */
/*  Display results                                                    */
/* ------------------------------------------------------------------ */
function displayResults(data) {
    var results = data.plan_results || [];
    var objects = data.objects || [];

    // Summary
    var totalPlanned = results.length;
    var totalOk = results.filter(function(r) { return r.success; }).length;
    var totalDetected = objects.length;
    var bar = document.getElementById('summaryBar');
    bar.innerHTML =
        '<div class="summary-item"><strong>Detected:</strong> ' + totalDetected + ' objects</div>' +
        '<div class="summary-item"><strong>Planned:</strong> ' + totalPlanned + '</div>' +
        '<div class="summary-item"><strong>Success:</strong> ' + totalOk + ' / ' + totalPlanned + '</div>';

    // Visualization
    var visCard = document.getElementById('visCard');
    if (data.visualization) {
        document.getElementById('visImage').src = 'data:image/jpeg;base64,' + data.visualization;
        visCard.style.display = 'block';
    } else {
        visCard.style.display = 'none';
    }

    // Table
    var tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var tr = document.createElement('tr');
        tr.className = r.success ? 'result-row-ok' : 'result-row-fail';

        var iid = r.instance_id || 'obj_?';
        var score = '-';
        for (var j = 0; j < objects.length; j++) {
            if ('obj_' + objects[j].index === iid) {
                score = objects[j].score.toFixed(4);
                break;
            }
        }

        var statusHtml = r.success
            ? '<span class="status-ok">OK</span>'
            : '<span class="status-fail">FAIL</span>';
        var elapsed = r.elapsed != null ? r.elapsed + 's' : '-';

        var phases = '';
        if (r.trajectory) {
            var parts = [];
            var keys = Object.keys(r.trajectory);
            for (var k = 0; k < keys.length; k++) {
                var ph = r.trajectory[keys[k]];
                var n = (ph && ph.positions) ? ph.positions.length : 0;
                parts.push(keys[k] + ':' + n);
            }
            phases = parts.join(', ');
        } else if (r.message) {
            phases = '<span style="color:#e74c3c;font-size:0.85em">' + r.message + '</span>';
        }

        tr.innerHTML = '<td>' + iid + '</td><td>' + score + '</td><td>' + statusHtml +
                       '</td><td>' + elapsed + '</td><td>' + phases + '</td>';
        tbody.appendChild(tr);
    }

    // Object detail cards
    var details = document.getElementById('objectDetails');
    details.innerHTML = '';
    for (var i = 0; i < objects.length; i++) {
        var obj = objects[i];
        var card = document.createElement('div');
        card.className = 'object-card';
        var bboxStr = obj.bbox && obj.bbox.length === 4
            ? '[' + obj.bbox.map(function(v) { return v.toFixed(1); }).join(', ') + ']'
            : '-';
        var catStr = obj.category && obj.category !== 'object' ? obj.category : '';
        card.innerHTML =
            '<div class="object-card-header">obj_' + obj.index + (catStr ? ' (' + catStr + ')' : '') + (obj.planned ? ' - planned' : '') + '</div>' +
            '<div class="object-card-row"><strong>Score:</strong> ' + obj.score.toFixed(4) + '</div>' +
            (catStr ? '<div class="object-card-row"><strong>Category:</strong> ' + catStr + '</div>' : '') +
            '<div class="object-card-row"><strong>BBox:</strong> ' + bboxStr + '</div>' +
            '<div class="object-card-row"><strong>Planned:</strong> ' + (obj.planned ? 'Yes' : 'No') + '</div>';
        details.appendChild(card);
    }

    // JSON
    var jsonSection = document.getElementById('jsonSection');
    jsonSection.style.display = 'block';
    document.getElementById('jsonPre').textContent = JSON.stringify(data, null, 2);

    // 3D viewer
    render3D(data);

    document.getElementById('resultsContainer').classList.add('show');
    document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ------------------------------------------------------------------ */
/*  3D Point Cloud & Trajectory                                        */
/* ------------------------------------------------------------------ */
function render3D(data) {
    var card = document.getElementById('viewer3dCard');
    if (typeof Plotly === 'undefined') {
        console.warn('Plotly.js not loaded â€” skipping 3D viewer');
        card.style.display = 'none';
        return;
    }
    var pc = data.pointcloud_3d;
    var kp = data.key_points_3d;

    if (!pc || (!pc.x.length && (!kp || !kp.per_object || !kp.per_object.length))) {
        card.style.display = 'none';
        return;
    }
    card.style.display = 'block';

    var traces = [];

    // Trace 1: point cloud
    if (pc && pc.x.length) {
        traces.push({
            type: 'scatter3d',
            mode: 'markers',
            name: 'Point Cloud',
            x: pc.x, y: pc.y, z: pc.z,
            marker: { size: 1, color: pc.colors, opacity: 0.6 },
            hoverinfo: 'x+y+z'
        });
    }

    // Color scheme
    var KP_COLORS = {
        Home:     '#3498db',
        Pregrasp: '#2ecc71',
        Grasp:    '#e74c3c',
        Basket:   '#f39c12'
    };

    // Trajectory line colors per object
    var LINE_COLORS = [
        '#e74c3c', '#2ecc71', '#3498db', '#f39c12',
        '#9b59b6', '#1abc9c', '#e67e22', '#34495e',
        '#d35400', '#8e44ad'
    ];

    if (kp && kp.per_object) {
        for (var i = 0; i < kp.per_object.length; i++) {
            var obj = kp.per_object[i];
            var waypoints = [];
            var labels = [];
            var markerColors = [];

            // Home
            if (kp.home) {
                waypoints.push(kp.home);
                labels.push('Home');
                markerColors.push(KP_COLORS.Home);
            }
            // Pregrasp
            if (obj.pregrasp) {
                waypoints.push(obj.pregrasp);
                labels.push('Pregrasp');
                markerColors.push(KP_COLORS.Pregrasp);
            }
            // Grasp
            if (obj.grasp) {
                waypoints.push(obj.grasp);
                labels.push('Grasp');
                markerColors.push(KP_COLORS.Grasp);
            }
            // Basket
            if (kp.basket) {
                waypoints.push(kp.basket);
                labels.push('Basket');
                markerColors.push(KP_COLORS.Basket);
            }
            // Return Home
            if (kp.home) {
                waypoints.push(kp.home);
                labels.push('Home');
                markerColors.push(KP_COLORS.Home);
            }

            if (waypoints.length < 2) continue;

            var wx = [], wy = [], wz = [];
            for (var j = 0; j < waypoints.length; j++) {
                wx.push(waypoints[j][0]);
                wy.push(waypoints[j][1]);
                wz.push(waypoints[j][2]);
            }

            var lineColor = LINE_COLORS[i % LINE_COLORS.length];
            var objLabel = obj.instance_id || ('obj_' + i);

            traces.push({
                type: 'scatter3d',
                mode: 'lines+markers+text',
                name: objLabel + ' trajectory',
                x: wx, y: wy, z: wz,
                marker: { size: 6, color: markerColors },
                line: { color: lineColor, width: 4 },
                text: labels,
                textposition: 'top center',
                textfont: { size: 10, color: '#333' },
                hoverinfo: 'text+x+y+z'
            });
        }
    }

    var layout = {
        scene: {
            aspectmode: 'data',
            camera: { eye: { x: 0, y: -1.5, z: 1 } },
            xaxis: { title: 'X (m)' },
            yaxis: { title: 'Y (m)' },
            zaxis: { title: 'Z (m)' },
            dragmode: 'orbit'
        },
        margin: { l: 0, r: 0, t: 30, b: 0 },
        legend: { x: 0.01, y: 0.99 }
    };

    Plotly.newPlot('plot3d', traces, layout, { responsive: true });
}

/* ------------------------------------------------------------------ */
/*  Helpers                                                            */
/* ------------------------------------------------------------------ */
function showError(msg) {
    var el = document.getElementById('errorMessage');
    el.textContent = msg;
    el.classList.add('show');
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function toggleJson() {
    var body = document.getElementById('jsonBody');
    var icon = document.getElementById('jsonIcon');
    if (body.style.display === 'block') {
        body.style.display = 'none';
        icon.innerHTML = '&#9654;';
    } else {
        body.style.display = 'block';
        icon.innerHTML = '&#9660;';
    }
}

function copyJson() {
    var text = document.getElementById('jsonPre').textContent;
    navigator.clipboard.writeText(text).then(function() {
        alert('JSON copied to clipboard!');
    }).catch(function() {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('JSON copied to clipboard!');
    });
}
</script>
</body>
</html>
